# Face Recognition API Backend

Flask REST API for face recognition using the `face_recognition` library. Processes images, detects faces, and matches them against trained encodings.

## Overview

The backend serves as the inference engine for the face recognition system. It loads pre-trained face encodings from `encodings.pkl` and provides REST endpoints for:
- Health checks
- Face recognition in uploaded images
- API information

## Quick Start

### Prerequisites

- Python 3.10+
- Trained model file (`encodings.pkl`) in the backend root directory

### Installation

```bash
cd backend

# Create virtual environment
python3 -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate

# Install dependencies
pip install --upgrade pip
pip install Flask==3.1.2 gunicorn==23.0.0 face-recognition==1.3.0 \
    Pillow==12.0.0 numpy==1.26.4 python-dotenv==1.0.0
```

### Running the API

**Development mode:**
```bash
python api/app.py
```

The API will start on `http://localhost:5001` (or the port specified by `PORT` environment variable).

**Production mode (with Gunicorn):**
```bash
gunicorn -w 2 -b 0.0.0.0:5000 --timeout 120 api.app:app
```

## API Endpoints

### `GET /`

Get API information and available endpoints.

**Response:**
```json
{
  "name": "Face Recognition API",
  "version": "1.0",
  "status": "healthy",
  "endpoints": {
    "/": "GET - API info",
    "/health": "GET - Health check",
    "/recognize": "POST - Recognize faces (multipart/form-data with \"image\" field)"
  }
}
```

### `GET /health`

Check API health and view loaded face encodings.

**Response:**
```json
{
  "status": "healthy",
  "faces_loaded": 150,
  "known_people": ["Alice", "Bob", "Charlie"]
}
```

### `POST /recognize`

Recognize faces in an uploaded image.

**Request:**
- Method: `POST`
- Content-Type: `multipart/form-data`
- Field name: `image`
- Body: Image file (JPG, PNG, etc.)

**Example with curl:**
```bash
curl -X POST http://localhost:5001/recognize \
  -F "image=@path/to/image.jpg"
```

**Response:**
```json
{
  "success": true,
  "faces": [
    {
      "name": "Alice",
      "confidence": 95.3,
      "location": {
        "top": 100,
        "right": 250,
        "bottom": 300,
        "left": 150
      }
    }
  ],
  "total_faces": 1,
  "image_size": {
    "width": 1920,
    "height": 1080
  }
}
```

**Error Response:**
```json
{
  "success": false,
  "error": "Error message here"
}
```

## Environment Variables

| Variable | Description | Default |
| --- | --- | --- |
| `PORT` | Server port | `5001` |

## Model Training

The API requires `encodings.pkl` to be present in the backend root directory. This file is generated by the training script in `model-train/`.

**Training workflow:**
1. Place labeled images in `model-train/training/<person_name>/`
2. Run training: `cd model-train && python train.py`
3. The trained `encodings.pkl` will be saved to `backend/encodings.pkl`
4. Restart the API to load the new encodings

## Docker Deployment

### Build Image

```bash
docker build -t face-recognition-api .
```

### Run Container

```bash
docker run -p 5000:5000 \
  -v $(pwd)/encodings.pkl:/app/encodings.pkl \
  face-recognition-api
```

### Docker Compose

```yaml
version: '3.8'
services:
  api:
    build: .
    ports:
      - "5000:5000"
    volumes:
      - ./encodings.pkl:/app/encodings.pkl
    environment:
      - PORT=5000
```

## Cloud Deployment

### Railway

1. Connect your GitHub repository
2. Set root directory to `backend/`
3. Start command: `gunicorn -w 2 -b 0.0.0.0:$PORT --timeout 120 api.app:app`
4. Ensure `encodings.pkl` is included in the repository

### Fly.io

```bash
fly launch
fly deploy
```

### Other Platforms

The API is a standard Flask app and can be deployed to:
- Heroku
- DigitalOcean App Platform
- AWS Elastic Beanstalk
- Google Cloud Run
- Azure App Service

## Project Structure

```
backend/
├── api/
│   └── app.py          # Flask application
├── encodings.pkl       # Trained face encodings (required)
├── Dockerfile          # Docker configuration
├── .dockerignore       # Docker ignore patterns
└── README.md           # This file
```

## Troubleshooting

**"Encodings not loaded" error:**
- Ensure `encodings.pkl` exists in the backend root directory
- Check file permissions
- Verify the file was generated correctly by the training script

**"Model not loaded" error:**
- The API failed to load encodings at startup
- Check server logs for the specific error
- Ensure the pickle file is not corrupted

**Recognition accuracy issues:**
- Lower the tolerance value (currently 0.6) for stricter matching
- Ensure training images are high quality and well-lit
- Add more training images per person

## Performance Notes

- Face detection uses HOG model (CPU-friendly). For better accuracy, use CNN model if GPU is available.
- Default tolerance is 0.6 (lower = stricter matching)
- Gunicorn workers: 2 (adjust based on server resources)
- Request timeout: 120 seconds

## Security Considerations

- Add authentication/authorization for production use
- Implement rate limiting
- Validate and sanitize uploaded images
- Use HTTPS in production
- Consider adding CORS headers if needed for frontend integration

